---
- name: Deploy Near-RT RIC on Server 16
  hosts: near_rt_ric
  become: yes
  gather_facts: yes
  
  vars:
    ansible_python_interpreter: /usr/bin/python3
  
  tasks:
    - name: Get server IP address
      shell: hostname -I | awk '{print $1}'
      register: server_ip
      changed_when: false
      failed_when: false
    
    - name: Display server IP
      debug:
        msg: "Server IP: {{ server_ip.stdout | default('Not available') }}"
      when: server_ip.stdout is defined
    
    - name: Check if Kubernetes cluster exists
      command: kubectl get nodes
      register: k8s_check
      failed_when: false
      changed_when: false
      environment:
        KUBECONFIG: "{{ ansible_env.HOME }}/.kube/config"
    
    - name: Display Kubernetes status
      debug:
        msg: "Kubernetes cluster status: {{ 'Running' if k8s_check.rc == 0 else 'Not found' }}"
    
    - name: Get user home directory
      shell: echo $HOME
      register: user_home
      changed_when: false
    
    - name: Set ric-dep path
      set_fact:
        ric_dep_path: "{{ user_home.stdout }}/ric-dep"
    
    - name: Remove existing ric-dep directory
      file:
        path: "{{ ric_dep_path }}"
        state: absent
    
    - name: Clone ric-dep repository
      git:
        repo: "{{ ric_dep_repo_url }}"
        dest: "{{ ric_dep_path }}"
        force: yes
    
    - name: Clean macOS metadata files
      find:
        paths: "{{ ric_dep_path }}"
        patterns: "._*"
      register: macos_files
    
    - name: Remove macOS metadata files
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ macos_files.files }}"
      when: macos_files.files | length > 0
    
    - name: Check if Helm is installed
      command: helm version --short
      register: helm_check
      failed_when: false
      changed_when: false
    
    - name: Install Helm if not present
      block:
        - name: Download Helm
          get_url:
            url: "https://get.helm.sh/helm-{{ helm_version }}-linux-amd64.tar.gz"
            dest: /tmp/helm-{{ helm_version }}-linux-amd64.tar.gz
        
        - name: Extract Helm
          unarchive:
            src: /tmp/helm-{{ helm_version }}-linux-amd64.tar.gz
            dest: /tmp
            remote_src: yes
        
        - name: Install Helm binary
          copy:
            src: /tmp/linux-amd64/helm
            dest: /usr/local/bin/helm
            mode: '0755'
            remote_src: yes
        
        - name: Cleanup Helm download
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - /tmp/helm-{{ helm_version }}-linux-amd64.tar.gz
            - /tmp/linux-amd64
      when: helm_check.rc != 0
    
    - name: Get user home directory
      shell: echo $HOME
      register: user_home
      changed_when: false
    
    - name: Set ric-dep path
      set_fact:
        ric_dep_path: "{{ user_home.stdout }}/ric-dep"
    
    - name: Package ric-common chart
      command: helm package ric-common/Common-Template/helm/ric-common
      args:
        chdir: "{{ ric_dep_path }}"
      register: package_result
      changed_when: "'Packaged' in package_result.stdout"
    
    - name: Create local Helm repository directory
      file:
        path: /tmp/local-repo
        state: directory
    
    - name: Find ric-common chart file
      find:
        paths: "{{ ric_dep_path }}"
        patterns: "ric-common-*.tgz"
      register: chart_files
    
    - name: Copy ric-common chart to local repo
      copy:
        src: "{{ item.path }}"
        dest: /tmp/local-repo/
        remote_src: yes
      loop: "{{ chart_files.files }}"
    
    - name: Create Helm repository index
      command: helm repo index /tmp/local-repo
      args:
        chdir: /tmp/local-repo
    
    - name: Check if local Helm repo server is running
      shell: pgrep -f "python3 -m http.server {{ helm_repo_port }}"
      register: helm_server_check
      failed_when: false
      changed_when: false
    
    - name: Stop existing Helm repo server
      shell: pkill -f "python3 -m http.server {{ helm_repo_port }}"
      when: helm_server_check.rc == 0
      failed_when: false
    
    - name: Start local Helm repository server
      shell: |
        cd /tmp/local-repo
        nohup python3 -m http.server {{ helm_repo_port }} > /tmp/helm-repo-server.log 2>&1 &
      async: 5
      poll: 0
      register: helm_server
    
    - name: Wait for Helm server to start
      wait_for:
        port: "{{ helm_repo_port }}"
        host: 127.0.0.1
        delay: 2
        timeout: 10
    
    - name: Add local Helm repository
      command: helm repo add local http://127.0.0.1:{{ helm_repo_port }}
      register: repo_add
      failed_when: false
      changed_when: "'already exists' not in repo_add.stderr"
    
    - name: Update Helm repositories
      command: helm repo update
      environment:
        KUBECONFIG: "{{ ansible_env.HOME }}/.kube/config"
    
    - name: Verify ric-common chart is available
      command: helm search repo local/ric-common
      register: ric_common_check
      environment:
        KUBECONFIG: "{{ ansible_env.HOME }}/.kube/config"
    
    - name: Display ric-common chart info
      debug:
        var: ric_common_check.stdout_lines
    
    - name: Make install script executable
      file:
        path: "{{ ric_dep_path }}/{{ ric_install_script }}"
        mode: '0755'
    
    - name: Check if PLATFORM subdirectory exists in recipe path
      stat:
        path: "{{ ric_dep_path }}/RECIPE_EXAMPLE/PLATFORM"
      register: platform_dir
    
    - name: Set recipe file path (with or without PLATFORM)
      set_fact:
        final_recipe_path: "{{ 'RECIPE_EXAMPLE/PLATFORM/example_recipe_latest_stable.yaml' if platform_dir.stat.exists else 'RECIPE_EXAMPLE/example_recipe_latest_stable.yaml' }}"
    
    - name: Verify recipe file exists
      stat:
        path: "{{ ric_dep_path }}/{{ final_recipe_path }}"
      register: recipe_file_check
    
    - name: Fail if recipe file not found
      fail:
        msg: "Recipe file not found at {{ ric_dep_path }}/{{ final_recipe_path }}"
      when: not recipe_file_check.stat.exists
    
    - name: Update recipe with server IP (final path)
      replace:
        path: "{{ ric_dep_path }}/{{ final_recipe_path }}"
        regexp: 'ricip: ".*"'
        replace: 'ricip: "{{ server_ip.stdout }}"'
    
    - name: Update recipe auxip with server IP (final path)
      replace:
        path: "{{ ric_dep_path }}/{{ final_recipe_path }}"
        regexp: 'auxip: ".*"'
        replace: 'auxip: "{{ server_ip.stdout }}"'
    
    - name: Install Near-RT RIC
      shell: |
        cd {{ ric_dep_path }}/bin
        ./install -f ../{{ final_recipe_path }}
      environment:
        KUBECONFIG: "{{ ansible_env.HOME }}/.kube/config"
      async: 1800
      poll: 30
      register: ric_install
    
    - name: Wait for Near-RT RIC installation to complete
      async_status:
        jid: "{{ ric_install.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 60
      delay: 30
    
    - name: Check installation result
      debug:
        msg: "Near-RT RIC installation completed with status: {{ job_result.ansible_job_id }}"
    
    - name: Verify RIC namespaces
      command: kubectl get namespaces
      register: namespaces
      environment:
        KUBECONFIG: "{{ ansible_env.HOME }}/.kube/config"
    
    - name: Display namespaces
      debug:
        var: namespaces.stdout_lines
    
    - name: Verify RIC Helm releases
      command: helm list -A
      register: helm_releases
      environment:
        KUBECONFIG: "{{ ansible_env.HOME }}/.kube/config"
    
    - name: Display Helm releases
      debug:
        var: helm_releases.stdout_lines
    
    - name: Check RIC platform pods
      command: kubectl get pods -n ricplt
      register: ricplt_pods
      environment:
        KUBECONFIG: "{{ ansible_env.HOME }}/.kube/config"
    
    - name: Display RIC platform pods
      debug:
        var: ricplt_pods.stdout_lines
    
    - name: Check appmgr health
      uri:
        url: "http://localhost:32080/appmgr/ric/v1/health/ready"
        method: GET
      register: appmgr_health
      failed_when: false
    
    - name: Display appmgr health status
      debug:
        msg: "AppMgr health: {{ 'Healthy' if appmgr_health.status == 200 else 'Not responding' }}"

